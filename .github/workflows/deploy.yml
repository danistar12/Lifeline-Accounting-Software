name: Auto Deploy to Server

on:
  push:
    branches: [ master, main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        timeout: 300s
        command_timeout: 60s
        script: |
          set -e
          export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"
          
          echo "ğŸš€ Starting deployment at $(date)"
          echo "Server: ${{ secrets.SERVER_HOST }}"
          echo "User: ${{ secrets.SSH_USER }}"
          
          # Navigate to project directory
          echo "ğŸ“ Navigating to project directory..."
          cd /var/www/lifeline-accounting || { echo "âŒ Failed to navigate to project directory"; exit 1; }
          
          # Show current status
          echo "ğŸ“Š Current git status:"
          git status --porcelain
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes from GitHub..."
          git fetch origin
          git pull origin master || { echo "âŒ Git pull failed"; exit 1; }
          
          # Backend setup
          echo "ğŸ Setting up backend..."
          cd backend || { echo "âŒ Backend directory not found"; exit 1; }
          
          # Activate virtual environment
          echo "ğŸ”§ Activating virtual environment..."
          source venv/bin/activate || { echo "âŒ Failed to activate venv"; exit 1; }
          
          # Set Django settings
          export DJANGO_SETTINGS_MODULE=lifeline_backend.settings_production
          
          # Check Django configuration
          echo "âœ… Running Django checks..."
          python manage.py check || { echo "âŒ Django check failed"; exit 1; }
          
          # Frontend build and deploy
          echo "ğŸŒ Building and deploying frontend..."
          cd ../frontend || { echo "âŒ Frontend directory not found"; exit 1; }
          
          # Install dependencies if needed
          echo "ğŸ“¦ Installing npm dependencies..."
          npm ci || npm install || { echo "âŒ npm install failed"; exit 1; }
          
          # Build frontend
          echo "ğŸ”¨ Building frontend..."
          npm run build || { echo "âŒ Frontend build failed"; exit 1; }
          
          # Deploy frontend with password
          echo "ğŸš€ Deploying frontend files..."
          echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S rsync -av --delete dist/ /var/www/html/ || { echo "âŒ Frontend deployment failed"; exit 1; }
          
          # Set proper permissions
          echo "ğŸ” Setting file permissions..."
          echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S chown -R www-data:www-data /var/www/html/ || { echo "âš ï¸ Permission setting failed but continuing"; }
          
          # Restart Apache
          echo "ğŸ”„ Restarting Apache..."
          echo "${{ secrets.SERVER_PASSWORD }}" | sudo -S systemctl restart apache2 || { echo "âŒ Apache restart failed"; exit 1; }
          
          # Verify Apache is running
          echo "ğŸ” Verifying Apache status..."
          systemctl is-active apache2 || { echo "âŒ Apache is not running after restart"; exit 1; }
          
          echo "âœ… Deployment completed successfully at $(date)!"
          echo "ğŸŒ Site should be available at: http://${{ secrets.SERVER_HOST }}"